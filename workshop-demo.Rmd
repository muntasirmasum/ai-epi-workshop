---
title: "AI-Assisted Statistical Analysis Workshop"
subtitle: "UAlbany AI+ Annual Symposium 2026"
author: "Muntasir Masum, PhD"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)

library(tidyverse)
library(NHANES)
library(broom)
library(ggeffects)
library(reshape2)
library(gridExtra)
```

# Welcome!

This notebook walks through the complete demo from the workshop. Run each section step-by-step to reproduce the analysis.

## How to Run Code in This Notebook

Each gray box below is a **code chunk**. You have three ways to run them:

1. **Run a single chunk:** Click the green **▶ Play** button at the top-right corner of any code chunk
2. **Run a single line:** Place your cursor on a line and press **Ctrl + Enter** (Windows) or **Cmd + Enter** (Mac)
3. **Run all chunks above:** Click the downward arrow icon ⏬ next to the Play button to run everything up to that point

> **Tip:** Start from the top and work your way down — later chunks depend on earlier ones!

---

**Need help?** Paste any code or output into [Claude](https://claude.ai) and ask:

- *"What does this do?"*
- *"Why am I getting this error?"*
- *"Explain this output like I'm a grad student"*

---

# 1. Prepare the Data

**Research question:** Does alcohol consumption predict blood pressure?

```{r data-prep}
data("NHANES")

analysis_data <- NHANES %>%
  filter(Age >= 20, Age <= 65) %>%
  filter(!is.na(BPSysAve), !is.na(AlcoholDay),
         !is.na(BMI), !is.na(SmokeNow),
         !is.na(Gender)) %>%
  mutate(
    drinks_per_week = AlcoholDay * 7,
    current_smoker = ifelse(SmokeNow == "Yes", 1, 0),
    drink_category = cut(AlcoholDay * 7,
      breaks = c(-Inf, 0, 7, 14, Inf),
      labels = c("None", "Light", "Moderate", "Heavy"))
  ) %>%
  select(ID, Gender, Age, BMI, drinks_per_week,
         drink_category, current_smoker, BPSysAve) %>%
  distinct(ID, .keep_all = TRUE)

glimpse(analysis_data)
```

---

# 2. Fit the Regression Model

```{r model}
model1 <- lm(
  BPSysAve ~ drinks_per_week + Age + BMI +
              current_smoker + Gender,
  data = analysis_data
)

summary(model1)
```

> **Try this:** Copy the `summary()` output above and paste it into [Claude](https://claude.ai). Ask: *"Explain this regression output to me like I'm a grad student who just learned what a p-value is."*

---

# 3. Interpret a Coefficient

```{r interpret}
# How much does BP change per additional drink/week?
coef(model1)["drinks_per_week"]

# Is it statistically significant?
summary(model1)$coefficients["drinks_per_week", "Pr(>|t|)"]
```

---

# 4. Visualizations

## 4a. Blood Pressure by Drinking Level

```{r violin-plot}
ggplot(analysis_data, aes(x = drink_category, y = BPSysAve,
                           fill = Gender)) +
  geom_violin(alpha = 0.35, position = position_dodge(0.8),
              color = NA, scale = "width") +
  geom_boxplot(width = 0.15, alpha = 0.9,
               position = position_dodge(0.8)) +
  labs(
    title = "Blood Pressure by Drinking Level and Sex",
    subtitle = "NHANES 2017-2018 | Adults 20-65",
    x = "Drinking Category",
    y = "Systolic Blood Pressure (mmHg)",
    fill = "Sex"
  ) +
  scale_fill_manual(values = c("female" = "#D55E00", "male" = "#0072B2"),
                    labels = c("female" = "Female", "male" = "Male")) +
  theme_minimal(base_size = 16) +
  theme(legend.position = "top")
```

## 4b. Correlation Matrix

```{r correlation}
corr_data <- analysis_data %>%
  select(Age, drinks_per_week, BPSysAve) %>%
  na.omit() %>%
  rename("Age" = Age,
         "Drinks/Week" = drinks_per_week,
         "Systolic BP" = BPSysAve)

cor_matrix <- cor(corr_data)
melted_cor <- melt(cor_matrix)

ggplot(melted_cor, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sprintf("%.2f", value)), size = 6, color = "white") +
  scale_fill_gradient2(low = "#0072B2", high = "#D55E00", mid = "white",
                       midpoint = 0, limit = c(-1, 1),
                       name = "Correlation") +
  theme_minimal(base_size = 16) +
  theme(axis.title = element_blank()) +
  coord_fixed() +
  labs(title = "Correlation Matrix of Key Variables")
```

## 4c. Coefficient Plot

```{r coef-plot}
coef_data <- tidy(model1, conf.int = TRUE) %>%
  filter(term != "(Intercept)") %>%
  mutate(term = case_when(
    term == "drinks_per_week" ~ "Drinks Per Week",
    term == "Gendermale" ~ "Sex (Male vs Female)",
    term == "Age" ~ "Age (Years)",
    term == "BMI" ~ "BMI (kg/m\u00b2)",
    term == "current_smoker" ~ "Current Smoker",
    TRUE ~ term
  ))

ggplot(coef_data, aes(x = estimate, y = term)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "#EAAA00",
             size = 1.2) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high),
                 height = 0.2, size = 1.2, color = "#461D7C") +
  geom_point(size = 4, color = "#461D7C") +
  labs(title = "Regression Coefficients with 95% CI",
       subtitle = "Effect on Systolic Blood Pressure (mmHg)",
       x = "Coefficient Estimate", y = "") +
  theme_minimal(base_size = 16)
```

## 4d. Predicted Effects

```{r predicted}
pred <- ggpredict(model1,
                  terms = c("drinks_per_week [0:80 by=2]", "Gender"))

ggplot(pred, aes(x = x, y = predicted, color = group, fill = group)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high),
              alpha = 0.15, color = NA) +
  geom_line(linewidth = 1.5) +
  scale_color_manual(values = c("female" = "#D55E00", "male" = "#0072B2"),
                     labels = c("female" = "Female", "male" = "Male")) +
  scale_fill_manual(values = c("female" = "#D55E00", "male" = "#0072B2"),
                    labels = c("female" = "Female", "male" = "Male")) +
  labs(
    title = "Predicted Systolic BP by Alcohol Consumption",
    subtitle = "Adjusted for Age, BMI, and Smoking | Shaded = 95% CI",
    x = "Drinks Per Week",
    y = "Predicted Systolic BP (mmHg)",
    color = "Sex", fill = "Sex"
  ) +
  theme_minimal(base_size = 16) +
  theme(legend.position = "top")
```

## 4e. Model Diagnostics

```{r diagnostics}
model_diag <- augment(model1)

p1 <- ggplot(model_diag, aes(x = .fitted, y = .resid)) +
  geom_point(alpha = 0.3, color = "#461D7C") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  geom_smooth(se = TRUE, color = "#0072B2") +
  labs(title = "Residuals vs Fitted", x = "Fitted", y = "Residuals") +
  theme_minimal(base_size = 14)

p2 <- ggplot(model_diag, aes(sample = .resid)) +
  stat_qq(alpha = 0.3, color = "#461D7C") +
  stat_qq_line(color = "red", linetype = "dashed") +
  labs(title = "Normal Q-Q Plot") +
  theme_minimal(base_size = 14)

grid.arrange(p1, p2, ncol = 2)
```

---

# 5. Debug Challenge

The code chunks below contain **deliberate errors** --- the kind of mistakes students make every day. Your job:

1. **Run the code** and read the error message
2. **Copy the error** and paste it into [Claude](https://claude.ai)
3. **Ask Claude** to explain what went wrong and how to fix it

> Think of this as practice for the real thing. Every R programmer hits these errors. The skill isn't avoiding them --- it's knowing how to get unstuck.

---

## Bug 1: The Missing Library

```{r bug1, eval=FALSE}
# Someone forgot something...
ggplot(mtcars, aes(x = wt, y = mpg)) +
  geom_point()
```

**What happens if you run this in a fresh R session without loading any packages?**

Try it, then paste the error into [Claude](https://claude.ai) and ask: *"I got this error in R. What's wrong?"*

<details>
<summary>Hint (click to reveal)</summary>
You need `library(ggplot2)` or `library(tidyverse)` first!
</details>

---

## Bug 2: The Typo That Haunts Everyone

```{r bug2, eval=FALSE}
# Spot the typo --- R can't
analysis_data %>%
  filter(Age >= 30) %>%
  summarize(mean_bp = mean(BPSysave))
```

Paste the error into [Claude](https://claude.ai) and ask: *"Why can't R find this variable?"*

<details>
<summary>Hint (click to reveal)</summary>
R is case-sensitive! It's `BPSysAve`, not `BPSysave`. One capital letter makes all the difference.
</details>

---

## Bug 3: The Classic Filter Trap

```{r bug3, eval=FALSE}
# This looks right... but it's not
analysis_data %>%
  filter(Gender = "female") %>%
  summarize(mean_bp = mean(BPSysAve))
```

Paste the error into [Claude](https://claude.ai) and ask: *"What's wrong with my filter statement?"*

<details>
<summary>Hint (click to reveal)</summary>
Use `==` for comparison, not `=`. Single `=` is assignment, double `==` is "is equal to."
</details>

---

## Bug 4: The Missing Pipe

```{r bug4, eval=FALSE}
# Something is missing between these lines...
analysis_data
  filter(Age >= 30)
  summarize(mean_bp = mean(BPSysAve))
```

Paste the error into [Claude](https://claude.ai) and ask: *"Why isn't this piped code working?"*

<details>
<summary>Hint (click to reveal)</summary>
You need the pipe operator `%>%` between each line:
`analysis_data %>% filter(Age >= 30) %>% summarize(...)`
</details>

---

## Bug 5: The Formula Fumble

```{r bug5, eval=FALSE}
# This regression formula has a problem
model_broken <- lm(
  BPSysAve ~ drinks_per_week + Age + BMI +
  data = analysis_data
)
```

Paste the error into [Claude](https://claude.ai) and ask: *"What's wrong with my lm() call?"*

<details>
<summary>Hint (click to reveal)</summary>
The formula ends with `+` before the comma. Remove the trailing `+` after `BMI`:
`BPSysAve ~ drinks_per_week + Age + BMI, data = analysis_data`
</details>

---

# 6. Your Turn!

Now that you've seen the full workflow, try these challenges:

**Challenge 1: Change the outcome**
What if we predicted BMI instead of blood pressure? Swap `BPSysAve` with `BMI` in the `lm()` formula and re-run.

**Challenge 2: Add an interaction**
Does the alcohol-BP relationship differ by sex? Use `drinks_per_week * Gender` in the formula.

**Challenge 3: Ask Claude anything**
Copy any output from this notebook and paste it into [Claude](https://claude.ai). Try:

- *"Is this model any good? What should I check?"*
- *"How do I interpret this coefficient?"*
- *"What other variables should I control for?"*

---

# Resources

- **Workshop slides:** [muntasirmasum.github.io/ai-epi-workshop](https://muntasirmasum.github.io/ai-epi-workshop/ai-epi-workshop.html)
- **GitHub repo:** [github.com/muntasirmasum/ai-epi-workshop](https://github.com/muntasirmasum/ai-epi-workshop)
- **Claude AI:** [claude.ai](https://claude.ai)
- **Questions?** [mmasum@albany.edu](mailto:mmasum@albany.edu)
